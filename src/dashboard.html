<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>Dashboard | WebCrawler</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="icon" href="/static/img/icon.png" />
</head>

<body>
  <!-- NAVBAR -->
  <header class="navbar">
    <div class="logo">ğŸ•·ï¸ WebCrawler</div>
    <div class="nav-links">
      <a href="/index.html">ğŸ  Home</a>
      <a href="/history.html">ğŸ“œ History</a>
      <a href="#" onclick="logout()" class="logout">Logout</a>
    </div>
  </header>

  <!-- MAIN CONTENT -->
  <div class="dashboard-container">
    <div class="crawl-box">
      <div class="crawl-header">
        <h1>AI Web Crawler</h1>
        <p>
          Paste any URL below and let Gemini summarize and analyze it
          intelligently.
        </p>
      </div>

      <div class="mode-selector">
        <label><input type="radio" name="mode" value="single" checked> Single URL</label>
        <label><input type="radio" name="mode" value="batch"> Batch URLs</label>
      </div>

      <div class="crawl-input-area">
        <input type="text" id="singleInput" placeholder="ğŸ”— https://example.com" style="display: block;" />
        <textarea id="batchInput"
          placeholder="ğŸ”— Enter multiple URLs, one per line&#10;https://example.com&#10;https://example2.com" rows="5"
          style="display: none;" class="batch-textarea"></textarea>
        <button class="btncrawl" id="startCrawl">Crawl</button>
      </div>

      <div id="crawlResult"></div>
    </div>
  </div>

  <footer>Â© 2025 WebCrawler | Built with ğŸ’¡ by Levellers</footer>

  <script>
    const API_BASE = "https://web-crawler-backend-51dl.onrender.com";

    const crawlBtn = document.getElementById("startCrawl");
    const resultDiv = document.getElementById("crawlResult");
    const singleInput = document.getElementById("singleInput");
    const batchInput = document.getElementById("batchInput");
    const modeRadios = document.querySelectorAll('input[name="mode"]');

    // Mode switching
    modeRadios.forEach(radio => {
      radio.addEventListener("change", (e) => {
        if (e.target.value === "single") {
          singleInput.style.display = "block";
          batchInput.style.display = "none";
        } else {
          singleInput.style.display = "none";
          batchInput.style.display = "block";
        }
      });
    });

    function logout() {
      fetch(`${API_BASE}/logout`, {
        method: "GET",
        credentials: "include"
      })
      .then(() => {
        window.location.href = "/index.html";
      })
      .catch(() => {
        alert("Logout failed. Please refresh.");
      });
    }

    crawlBtn.addEventListener("click", async () => {
      const mode = document.querySelector('input[name="mode"]:checked').value;
      let urls = [];

      if (mode === "single") {
        const url = singleInput.value.trim();
        if (!url) {
          resultDiv.innerText = "âš ï¸ Please enter a valid URL.";
          return;
        }
        urls = [url];
      } else {
        urls = batchInput.value
          .split("\n")
          .map(u => u.trim())
          .filter(Boolean);

        if (urls.length === 0) {
          resultDiv.innerText = "âš ï¸ Please enter at least one valid URL.";
          return;
        }
      }

      resultDiv.innerText =
        `ğŸ§  Fetching and analyzing ${urls.length} URL${urls.length > 1 ? "s" : ""}...`;

      try {
        const res = await fetch(`${API_BASE}/crawl`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include", // ğŸ”¥ REQUIRED FOR SESSION
          body: JSON.stringify({ urls })
        });

        const data = await res.json();

        if (!res.ok) {
          resultDiv.innerText = data.error || "âŒ Crawl failed.";
          return;
        }

        if (mode === "single") {
          const r = data.results[0];
          resultDiv.innerHTML = `
            <h3>${r.title || "Untitled Page"}</h3>
            <p><strong>URL:</strong>
              <a href="${r.url}" target="_blank">${r.url}</a>
            </p>
            <p><strong>Summary:</strong></p>
            <pre>${r.summary}</pre>
            <p style="color:gray;">âœ… Saved to your crawl history.</p>
          `;
        } else {
          resultDiv.innerHTML = `
            <h3>Batch Crawl Completed</h3>
            <p><strong>Batch ID:</strong> ${data.batch_id}</p>
            <ul>
              ${data.results.map(r => `
                <li>
                  <strong>${r.title || "Untitled Page"}</strong> â€“
                  <a href="${r.url}" target="_blank">${r.url}</a>
                  ${r.error ? `<span style="color:red;"> (${r.error})</span>` : ""}
                </li>
              `).join("")}
            </ul>
            <p style="color:gray;">âœ… Saved to your crawl history.</p>
          `;
        }

      } catch (err) {
        console.error(err);
        resultDiv.innerText = "ğŸš¨ Error connecting to server.";
      }
    });
  </script>
  <script src="/static/script.js"></script>
</body>

</html>