<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Crawl History | WebCrawler</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='/style.css') }}"/>
    <link rel="icon" href="{{ url_for('static', filename='/templates/img/icon.png') }}"/>
  </head>

  <body>
    <!-- NAVBAR -->
    <header class="navbar">
      <div class="logo">ğŸ•·ï¸ WebCrawler</div>
      <div class="nav-links">
        <a href="{{ url_for('dashboard') }}">Dashboard</a>
        <a href="{{ url_for('history') }}" class="active">History</a>
        <a href="{{ url_for('logout') }}" class="logout">Logout</a>
      </div>
    </header>

    <!-- MAIN -->
    <div class="container">
      <h1>ğŸ“œ Crawl History</h1>

      <div class="search-box">
        <input
          type="text"
          id="searchInput"
          placeholder="ğŸ” Search crawled sites by title or URL..."
        />
      </div>

      {% if results and results|length > 0 %}
      <div class="crawl-list" id="crawlList">
        {% for item in results %}
        <div class="card">
          <h3>{{ item.title or "Untitled Page" }}</h3>
          <a href="{{ item.url }}" target="_blank">{{ item.url }}</a>
          <p><strong>Summary:</strong></p>
          <pre>{{ item.summary }}</pre>

          <details>
            <summary>View Extracted Raw Text</summary>
            <pre>
{{ (item.raw_text or "No raw text available")[:1000] }}...</pre
            >
          </details>

          <small>ğŸ•’ Crawled on: {{ item.created_at }}</small>
          <div class="download-buttons">
            <button id="downloadCSV-{{ loop.index }}" class="btn">Download CSV</button>
            <button id="downloadPDF-{{ loop.index }}" class="btn">Download PDF</button>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="no-history">No crawl history found ğŸ˜¢</div>
      {% endif %}
    </div>

    <footer>Â© 2025 WebCrawler by Levellers</footer>

    <script>
      // Live Search Filter
      const searchInput = document.getElementById("searchInput");
      const cards = document.querySelectorAll(".card");

      searchInput.addEventListener("input", (e) => {
        const query = e.target.value.toLowerCase();
        cards.forEach((card) => {
          const title = card.querySelector("h3").innerText.toLowerCase();
          const url = card.querySelector("a").innerText.toLowerCase();
          card.style.display =
            title.includes(query) || url.includes(query) ? "flex" : "none";
        });
      });

      // Download functionality
      {% for item in results %}
      document.getElementById("downloadCSV-{{ loop.index }}").onclick = async () => {
        const response = await fetch("/download/csv", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ url: "{{ item.url }}", summary: "{{ item.summary }}" })
        });
        const blob = await response.blob();
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "crawl_report.csv";
        link.click();
      };

      document.getElementById("downloadPDF-{{ loop.index }}").onclick = async () => {
        const response = await fetch("/download/pdf", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ url: "{{ item.url }}", summary: "{{ item.summary }}" })
        });
        const blob = await response.blob();
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "crawl_report.pdf";
        link.click();
      };
      {% endfor %}
    </script>
  </body>
</html>